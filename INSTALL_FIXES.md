# Исправления скриптов установки и удаления

## Проблемы, которые были исправлены

### 1. Ошибка "Failed to connect to bus: No medium found"

**Проблема**: При установке через `sudo` возникала ошибка при попытке создать systemd пользовательский сервис.

**Причина**: 
- Скрипт запускался через sudo, но пытался создать пользовательский сервис
- В некоторых средах (контейнеры, SSH без X11) systemd user session недоступен
- Отсутствовала проверка доступности systemd user session

**Исправление**:
- Добавлена функция `check_systemd_user()` для проверки доступности systemd user session
- Добавлена обработка случаев когда systemd недоступен
- Скрипт теперь корректно работает даже если systemd user session недоступен
- Предоставляются альтернативные способы запуска (ручной запуск, crontab)

### 2. Улучшена обработка ошибок

**Исправления**:
- Добавлены проверки перед выполнением systemd команд
- Улучшена обработка ошибок при создании и запуске сервиса
- Добавлены информативные сообщения о причинах проблем

### 3. Исправлена работа с правами доступа

**Исправления**:
- Улучшена установка владельца файлов при запуске через sudo
- Добавлены дополнительные проверки прав доступа
- Исправлена установка владельца для файла systemd сервиса

### 4. Улучшен скрипт удаления (uninstall.sh)

**Исправления**:
- Добавлена проверка доступности systemd перед попыткой остановки сервиса
- Добавлена принудительная остановка процессов через `pkill`
- Улучшена обработка случаев когда systemd недоступен
- Более корректная проверка наличия других пользовательских сервисов

## Новые возможности

### 1. Автоматическое определение среды

Скрипт теперь автоматически определяет:
- Доступность systemd user session
- Возможность создания пользовательских сервисов
- Необходимость альтернативных методов запуска

### 2. Fallback методы

Если systemd недоступен, скрипт предлагает:
- Ручной запуск через `start.sh`
- Настройку через crontab
- Отложенную настройку systemd

### 3. Улучшенная диагностика

Добавлены информативные сообщения о:
- Причинах недоступности systemd
- Альтернативных способах запуска
- Рекомендациях по настройке

## Тестирование

Создан тестовый скрипт `test_scripts.sh` который проверяет:
- Синтаксическую корректность скриптов
- Наличие всех необходимых функций
- Правильность ссылок на репозиторий
- Обработку аргументов командной строки
- Обработку ошибок
- Корректную работу с systemd

## Использование

### Установка
```bash
# Автоматическая установка
curl -sSL "https://raw.githubusercontent.com/sanfisko/toyota-dashboard/main/install.sh" | sudo bash

# Автоматическая установка без интерактивных запросов
curl -sSL "https://raw.githubusercontent.com/sanfisko/toyota-dashboard/main/install.sh" | sudo bash -s -- -y
```

### Удаление
```bash
# Интерактивное удаление
curl -sSL "https://raw.githubusercontent.com/sanfisko/toyota-dashboard/main/uninstall.sh" | bash

# Автоматическое удаление
curl -sSL "https://raw.githubusercontent.com/sanfisko/toyota-dashboard/main/uninstall.sh" | bash -s -- -y
```

### Управление сервисом

Если systemd доступен:
```bash
systemctl --user start toyota-dashboard
systemctl --user stop toyota-dashboard
systemctl --user restart toyota-dashboard
systemctl --user status toyota-dashboard
```

Если systemd недоступен:
```bash
# Запуск
~/toyota-dashboard/start.sh

# Остановка
~/toyota-dashboard/stop.sh

# Обновление
~/toyota-dashboard/update.sh
```

## Совместимость

Скрипты теперь корректно работают в:
- Обычных Linux системах с systemd
- Контейнерах Docker/LXC
- SSH сессиях без X11 forwarding
- Системах без systemd user session
- Chroot окружениях

## Логи и диагностика

При проблемах с установкой проверьте:
1. Логи установки (выводятся в консоль)
2. Доступность systemd: `systemctl --user status`
3. Права доступа к домашней директории
4. Наличие Python 3.8+

Для диагностики сервиса:
```bash
# Если systemd доступен
journalctl --user -u toyota-dashboard -f

# Если systemd недоступен
tail -f ~/toyota-dashboard/logs/app.log
```