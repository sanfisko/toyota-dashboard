#!/bin/bash

# Toyota Dashboard - Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ
# ÐŸÐ¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ ÑƒÐ´Ð°Ð»ÑÐµÑ‚ Toyota Dashboard Server Ñ Raspberry Pi

set -e

# ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
AUTO_CONFIRM=false

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
while [[ $# -gt 0 ]]; do
    case $1 in
        -y|--yes)
            AUTO_CONFIRM=true
            shift
            ;;
        -h|--help)
            echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: $0 [Ð¾Ð¿Ñ†Ð¸Ð¸]"
            echo "ÐžÐ¿Ñ†Ð¸Ð¸:"
            echo "  -y, --yes    ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ"
            echo "  -h, --help   ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ"
            exit 0
            ;;
        *)
            echo "ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾Ð¿Ñ†Ð¸Ñ: $1"
            echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ -h Ð´Ð»Ñ ÑÐ¿Ñ€Ð°Ð²ÐºÐ¸"
            exit 1
            ;;
    esac
done

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ ÐºÑ€Ð°ÑÐ¸Ð²Ð¾Ð³Ð¾ Ð²Ñ‹Ð²Ð¾Ð´Ð°
print_header() {
    echo -e "${BLUE}================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}================================${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        print_error "Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ root"
        echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ: sudo $0"
        exit 1
    fi
}



# ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÐ°
remove_service() {
    print_info "ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÐ°..."
    
    # ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²Ð¸Ñ
    if systemctl is-active --quiet toyota-dashboard; then
        systemctl stop toyota-dashboard
        print_success "Ð¡ÐµÑ€Ð²Ð¸Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
    fi
    
    # ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº
    if systemctl is-enabled --quiet toyota-dashboard; then
        systemctl disable toyota-dashboard
        print_success "ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½"
    fi
    
    # Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» ÑÐµÑ€Ð²Ð¸ÑÐ°
    if [[ -f /etc/systemd/system/toyota-dashboard.service ]]; then
        rm -f /etc/systemd/system/toyota-dashboard.service
        systemctl daemon-reload
        print_success "Ð¤Ð°Ð¹Ð» ÑÐµÑ€Ð²Ð¸ÑÐ° ÑƒÐ´Ð°Ð»ÐµÐ½"
    fi
}

# Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
remove_nginx() {
    print_info "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."
    
    # ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑÐ°Ð¹Ñ‚
    if [[ -L /etc/nginx/sites-enabled/toyota-dashboard ]]; then
        rm -f /etc/nginx/sites-enabled/toyota-dashboard
        print_success "Ð¡Ð°Ð¹Ñ‚ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½"
    fi
    
    # Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
    if [[ -f /etc/nginx/sites-available/toyota-dashboard ]]; then
        rm -f /etc/nginx/sites-available/toyota-dashboard
        print_success "ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ nginx ÑƒÐ´Ð°Ð»ÐµÐ½Ð°"
    fi
    
    # ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ nginx
    if systemctl is-active --quiet nginx; then
        systemctl reload nginx
        print_success "Nginx Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½"
    fi
}

# Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
remove_files() {
    print_info "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
    
    # Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
    if [[ -d /opt/toyota-dashboard ]]; then
        rm -rf /opt/toyota-dashboard
        print_success "Ð¤Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹"
    fi
    
    # Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸
    if [[ -d /var/log/toyota-dashboard ]]; then
        rm -rf /var/log/toyota-dashboard
        print_success "Ð›Ð¾Ð³Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹"
    fi
    
    # Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
    if [[ -d /tmp/toyota-dashboard ]]; then
        rm -rf /tmp/toyota-dashboard
        print_success "Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹"
    fi
}

# Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
remove_user() {
    print_info "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ toyota..."
    
    if id "toyota" &>/dev/null; then
        # Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ Ð²ÑÐµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
        pkill -u toyota || true
        
        # Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ ÐµÐ³Ð¾ Ð´Ð¾Ð¼Ð°ÑˆÐ½ÑŽÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
        userdel -r toyota 2>/dev/null || userdel toyota 2>/dev/null || true
        
        # Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ ÐµÑÐ»Ð¸ Ð¾Ð½Ð° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
        groupdel toyota 2>/dev/null || true
        
        print_success "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ toyota ÑƒÐ´Ð°Ð»ÐµÐ½"
    fi
}

# Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð» Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°
remove_firewall() {
    print_info "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð» Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°..."
    
    # UFW Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°
    if command -v ufw >/dev/null 2>&1; then
        ufw --force delete allow 2025 2>/dev/null || true
        ufw --force delete allow 80 2>/dev/null || true
        ufw --force delete allow 443 2>/dev/null || true
        print_success "UFW Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹"
    fi
    
    # iptables Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° (ÐµÑÐ»Ð¸ UFW Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ)
    if ! command -v ufw >/dev/null 2>&1; then
        iptables -D INPUT -p tcp --dport 2025 -j ACCEPT 2>/dev/null || true
        iptables -D INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null || true
        iptables -D INPUT -p tcp --dport 443 -j ACCEPT 2>/dev/null || true
        
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° iptables
        if command -v iptables-save >/dev/null 2>&1; then
            iptables-save > /etc/iptables/rules.v4 2>/dev/null || true
        fi
        
        print_success "iptables Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹"
    fi
}

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
cleanup_packages() {
    print_info "ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
    
    read -p "Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Python Ð¿Ð°ÐºÐµÑ‚Ñ‹? (y/n): " -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð´Ñ€ÑƒÐ³Ð¸Ð¼Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÐ¼Ð¸
        pip3 uninstall -y fastapi uvicorn aiosqlite pyyaml 2>/dev/null || true
        print_success "Python Ð¿Ð°ÐºÐµÑ‚Ñ‹ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹"
    fi
    
    # ÐÐ²Ñ‚Ð¾Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ°
    apt autoremove -y >/dev/null 2>&1 || true
    apt autoclean >/dev/null 2>&1 || true
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¾Ð± ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸
create_removal_report() {
    local report_file="/tmp/toyota-dashboard-removal-$(date +%Y%m%d_%H%M%S).log"
    
    cat > "$report_file" << EOF
Toyota Dashboard - ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾Ð± ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸
=====================================
Ð”Ð°Ñ‚Ð°: $(date)
ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: $(whoami)
Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð°: $(uname -a)

Ð£Ð´Ð°Ð»ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹:
âœ… Ð¡ÐµÑ€Ð²Ð¸Ñ toyota-dashboard
âœ… Ð¤Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (/opt/toyota-dashboard)
âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ toyota
âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ nginx
âœ… Ð›Ð¾Ð³Ð¸ (/var/log/toyota-dashboard)
âœ… ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°
âœ… Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹

Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾
EOF

    print_success "ÐžÑ‚Ñ‡ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½: $report_file"
}

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
main() {
    print_header "ðŸ—‘ï¸  TOYOTA DASHBOARD UNINSTALLER"
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ¸
    check_root
    
    # ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ
    print_header "ðŸ—‘ï¸  Ð£Ð”ÐÐ›Ð•ÐÐ˜Ð• TOYOTA DASHBOARD"
    echo
    print_warning "Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚:"
    echo "   â€¢ Ð¡ÐµÑ€Ð²Ð¸Ñ toyota-dashboard"
    echo "   â€¢ Ð’ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (/opt/toyota-dashboard)"
    echo "   â€¢ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ toyota"
    echo "   â€¢ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ nginx"
    echo "   â€¢ Ð‘Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ Ð»Ð¾Ð³Ð¸"
    echo "   â€¢ ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°"
    echo
    print_warning "Ð”Ð°Ð½Ð½Ñ‹Ðµ Toyota credentials Ð¸ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ð¾ÐµÐ·Ð´Ð¾Ðº Ð±ÑƒÐ´ÑƒÑ‚ Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ½Ñ‹!"
    echo
    
    echo "DEBUG: AUTO_CONFIRM=$AUTO_CONFIRM"
    echo "DEBUG: Checking terminal: [[ -t 0 ]]"
    
    # Ð•ÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½ Ñ„Ð»Ð°Ð³ -y, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ
    if [[ "$AUTO_CONFIRM" == "true" ]]; then
        print_info "ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ (-y Ñ„Ð»Ð°Ð³)"
        print_info "ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ..."
    else
        echo "DEBUG: AUTO_CONFIRM is not true, checking terminal..."
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð»Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾
        if [[ -t 0 ]]; then
            echo "DEBUG: Terminal is interactive"
            # Ð˜Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ - Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ
            read -p "Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Toyota Dashboard? (yes/no): " -r
            if [[ ! $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
                print_info "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð¾"
                exit 0
            fi
            
            echo
            read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ 'DELETE' Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ: " -r
            if [[ $REPLY != "DELETE" ]]; then
                print_info "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð¾"
                exit 0
            fi
        else
            echo "DEBUG: Terminal is NOT interactive"
            # ÐÐµÐ¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ (curl | bash) - Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ
            print_info "ÐÐµÐ¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼: Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Toyota Dashboard..."
            sleep 2  # ÐÐµÐ±Ð¾Ð»ÑŒÑˆÐ°Ñ Ð¿Ð°ÑƒÐ·Ð° Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ð¹
        fi
    fi
    
    echo "DEBUG: Confirmation logic completed"
    
    print_header "ðŸš€ ÐÐÐ§Ð˜ÐÐÐ•Ðœ Ð£Ð”ÐÐ›Ð•ÐÐ˜Ð•"
    
    # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
    remove_service
    remove_nginx
    remove_files
    remove_user
    remove_firewall
    cleanup_packages
    
    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
    create_removal_report
    
    print_header "âœ… Ð£Ð”ÐÐ›Ð•ÐÐ˜Ð• Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž"
    echo
    print_success "Toyota Dashboard Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ ÑƒÐ´Ð°Ð»ÐµÐ½ Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹"
    echo
    print_info "Ð§Ñ‚Ð¾ Ð±Ñ‹Ð»Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾:"
    echo "   â€¢ Ð¡ÐµÑ€Ð²Ð¸Ñ Ð¸ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº"
    echo "   â€¢ Ð’ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
    echo "   â€¢ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ toyota"
    echo "   â€¢ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ nginx"
    echo "   â€¢ Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ Ð»Ð¾Ð³Ð¸"
    echo "   â€¢ ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°"
    echo
    print_warning "Ð•ÑÐ»Ð¸ Ð²Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Toyota Dashboard:"
    echo "curl -sSL https://raw.githubusercontent.com/sanfisko/toyota-dashboard/main/install.sh | sudo bash"
    echo
    print_info "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Toyota Dashboard! ðŸš—"
}

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¸Ð³Ð½Ð°Ð»Ð¾Ð²
trap 'print_error "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€ÐµÑ€Ð²Ð°Ð½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼"; exit 1' INT TERM

# Ð—Ð°Ð¿ÑƒÑÐº
main "$@"