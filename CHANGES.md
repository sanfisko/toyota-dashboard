# Изменения в Toyota Dashboard

## Исправленные проблемы

### 1. Унификация портов
- **Проблема**: В install.sh использовались разные порты (2025 и 12000)
- **Решение**: Оставлен только порт 2025 для всех компонентов
- **Файлы**: `install.sh`

### 2. Удаление выбора сервера/региона
- **Проблема**: Пользователи могли выбирать регион (Europe, North America, Asia)
- **Решение**: Зафиксирован регион "europe" для европейских автомобилей
- **Файлы**: `static/setup.html`, `setup_config.py`

### 3. Исправление проблемы с правами доступа к /opt
- **Проблема**: Приложение не могло сохранить конфигурацию в /opt/toyota-dashboard/
- **Решение**: 
  - Улучшена логика определения пути к конфигурации в `paths.py`
  - Добавлено автоматическое копирование конфигурации в пользовательскую директорию
  - Созданы дополнительные директории с правильными правами доступа
- **Файлы**: `paths.py`, `install.sh`

### 4. Исправление пользователя в systemd сервисе
- **Проблема**: В toyota-dashboard.service был указан пользователь "sanfisko"
- **Решение**: Изменен на пользователя "toyota"
- **Файлы**: `toyota-dashboard.service`

### 5. Использование виртуального окружения в systemd
- **Проблема**: Сервис использовал системный Python вместо виртуального окружения
- **Решение**: Изменен путь к Python на `/opt/toyota-dashboard/venv/bin/python`
- **Файлы**: `toyota-dashboard.service`

## Структура директорий после исправлений

```
/opt/toyota-dashboard/          # Код приложения (только для чтения)
/var/lib/toyota-dashboard/      # Данные приложения
/var/log/toyota-dashboard/      # Логи
/etc/toyota-dashboard/          # Системная конфигурация
/home/toyota/.config/toyota-dashboard/  # Пользовательская конфигурация
/home/toyota/.cache/toyota-dashboard/   # Кэш
/home/toyota/.local/share/toyota-dashboard/  # Пользовательские данные
```

## Приоритет конфигурации

1. `/home/toyota/.config/toyota-dashboard/config.yaml` (пользовательская)
2. `/etc/toyota-dashboard/config.yaml` (системная)
3. `/opt/toyota-dashboard/config.yaml` (только для чтения, копируется в пользовательскую)

## Дополнительные исправления (v2)

### 6. Исправление проблем с запуском сервиса
- **Проблема**: Сервис не мог запуститься из-за отсутствия прав доступа к домашней директории
- **Решение**: Добавлено автоматическое создание и настройка прав в systemd сервисе
- **Файлы**: `toyota-dashboard.service`

### 7. Улучшенная обработка конфигурации
- **Проблема**: Приложение падало если конфигурационный файл не найден
- **Решение**: 
  - Добавлен поиск конфигурации в альтернативных путях
  - Создание базовой конфигурации по умолчанию
  - Подробное логирование процесса загрузки
- **Файлы**: `app.py`

### 8. Улучшенная установка конфигурации
- **Проблема**: Конфигурация создавалась только в одном месте
- **Решение**: Автоматическое копирование в системную и пользовательскую директории
- **Файлы**: `install.sh`

## Рекомендации по использованию

1. Конфигурация теперь автоматически сохраняется в правильном месте
2. Регион зафиксирован на "europe" - изменение не требуется
3. Используется только порт 2025
4. Все права доступа настроены автоматически при установке
5. Сервис теперь должен запускаться без ошибок прав доступа
6. При отсутствии конфигурации создается базовая версия