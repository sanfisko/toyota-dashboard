# Исправление ошибки "Read-only file system"

## Описание проблемы

При работе Toyota Dashboard на Raspberry Pi может возникать ошибка:
```
Ошибка сохранения конфигурации: [Errno 30] Read-only file system: '/etc/toyota-dashboard/config.yaml'
```

Эта ошибка возникает, когда система пытается записать конфигурацию в системную директорию `/etc/toyota-dashboard/`, но файловая система смонтирована в режиме "только для чтения".

## Внесенные исправления

### 1. Улучшенная проверка доступности системных директорий

**Файл:** `paths.py`

Функция `_can_use_system_dirs()` теперь проверяет все критически важные системные директории:
- `/var/lib/toyota-dashboard` (данные)
- `/var/log/toyota-dashboard` (логи)  
- `/etc/toyota-dashboard` (конфигурация)

Если хотя бы одна директория недоступна для записи, система автоматически переключается на пользовательские директории.

### 2. Улучшенная логика выбора пути конфигурации

**Файл:** `paths.py`, свойство `config_file`

Новая логика выбора пути к файлу конфигурации в порядке приоритета:

1. **Пользовательская конфигурация** - `~/.config/toyota-dashboard/config.yaml`
2. **Системная конфигурация** (с проверкой прав) - `/etc/toyota-dashboard/config.yaml`
3. **Конфигурация в директории приложения** - `/opt/toyota-dashboard/config.yaml`
4. **Fallback к пользовательской директории**

### 3. Улучшенная обработка ошибок при сохранении

**Файл:** `app.py`, функция `save_config()`

Добавлены:
- Проверка прав доступа перед записью
- Создание резервных копий
- Fallback к альтернативным путям при ошибках
- Подробное логирование ошибок
- Информативные сообщения об ошибках

### 4. API для диагностики системы

**Новые endpoints:**
- `GET /api/system/paths` - информация о путях и правах доступа
- `GET /diagnostics` - веб-страница диагностики

### 5. Диагностическая веб-страница

**Файл:** `static/diagnostics.html`

Новая страница для диагностики системы, доступная по адресу `/diagnostics`, показывает:
- Информацию о всех путях
- Статус файла конфигурации
- Права доступа к директориям
- Альтернативные пути
- Рекомендации по устранению проблем

## Быстрое исправление

### Автоматический скрипт исправления

Запустите автоматический скрипт для исправления всех проблем с правами доступа:

```bash
# Скачать и запустить скрипт исправления
curl -sSL "https://raw.githubusercontent.com/sanfisko/toyota-dashboard/main/fix_permissions.sh" | sudo bash

# Или если файл уже скачан:
cd /opt/toyota-dashboard
sudo ./fix_permissions.sh
```

Этот скрипт автоматически:
- Создаст все необходимые директории
- Установит правильные права доступа
- Скопирует конфигурацию в пользовательскую директорию
- Перезапустит сервис
- Проверит результат

## Как использовать исправления

### 1. Автоматическое переключение

Система теперь автоматически определяет доступность системных директорий и при необходимости переключается на пользовательские:

```bash
# Если системные директории недоступны, будут использованы:
~/.config/toyota-dashboard/config.yaml  # вместо /etc/toyota-dashboard/config.yaml
~/.local/share/toyota-dashboard/        # вместо /var/lib/toyota-dashboard/
~/.local/share/toyota-dashboard/logs/   # вместо /var/log/toyota-dashboard/
```

### 2. Диагностика проблем

Откройте в браузере страницу диагностики:
```
http://your-raspberry-pi-ip/diagnostics
```

Или используйте API:
```bash
curl http://your-raspberry-pi-ip/api/system/paths
```

### 3. Ручное исправление прав доступа

Если нужно использовать системные директории, исправьте права доступа:

```bash
# Создать директории с правильными правами
sudo mkdir -p /etc/toyota-dashboard
sudo mkdir -p /var/lib/toyota-dashboard
sudo mkdir -p /var/log/toyota-dashboard

# Установить владельца
sudo chown -R toyota:toyota /etc/toyota-dashboard
sudo chown -R toyota:toyota /var/lib/toyota-dashboard  
sudo chown -R toyota:toyota /var/log/toyota-dashboard

# Установить права доступа
sudo chmod -R 755 /etc/toyota-dashboard
sudo chmod -R 755 /var/lib/toyota-dashboard
sudo chmod -R 755 /var/log/toyota-dashboard

# Перезапустить сервис
sudo systemctl restart toyota-dashboard
```

### 4. Принудительное использование пользовательских директорий

Если хотите принудительно использовать пользовательские директории:

```bash
# Создать пользовательские директории
mkdir -p ~/.config/toyota-dashboard
mkdir -p ~/.local/share/toyota-dashboard
mkdir -p ~/.cache/toyota-dashboard

# Скопировать существующую конфигурацию
sudo cp /etc/toyota-dashboard/config.yaml ~/.config/toyota-dashboard/ 2>/dev/null || true

# Установить переменную окружения (опционально)
export TOYOTA_DASHBOARD_USE_USER_DIRS=1
```

## Тестирование исправлений

### 1. Тест системы путей

```bash
cd /opt/toyota-dashboard
python3 test_paths.py
```

### 2. Тест API (требует установленного FastAPI)

```bash
cd /opt/toyota-dashboard  
python3 test_api.py
```

### 3. Проверка через веб-интерфейс

1. Откройте главную страницу: `http://your-raspberry-pi-ip/`
2. Нажмите кнопку "Диагностика" в разделе "Инструменты"
3. Проверьте статус всех путей и директорий

## Логирование

Все операции с конфигурацией теперь подробно логируются. Проверьте логи:

```bash
# Логи сервиса
sudo journalctl -u toyota-dashboard -f

# Логи приложения (если доступны)
tail -f /var/log/toyota-dashboard/app.log
# или
tail -f ~/.local/share/toyota-dashboard/logs/app.log
```

## Рекомендации

1. **Используйте диагностическую страницу** для быстрой проверки состояния системы
2. **Проверяйте логи** при возникновении проблем с сохранением конфигурации
3. **Делайте резервные копии** конфигурации перед изменениями
4. **Используйте пользовательские директории** если системные недоступны

## Совместимость

Исправления полностью обратно совместимы:
- Существующие установки продолжат работать без изменений
- Автоматическое определение лучшего пути для конфигурации
- Graceful fallback при проблемах с правами доступа